<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>{{ lesson.title }} | {{ course.name }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --bg:#071021; --bg2:#050816; --panel:#0b1220; --card:#0e1722;
      --text:#e6eef8; --muted:#9fb3c8; --accent:#00ffcc; --accent2:#6C5CE7;
      --bd:1px solid rgba(255,255,255,.06);
      --shadow:0 18px 40px rgba(2,6,23,.6);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family:"Inter",system-ui;
      background:linear-gradient(180deg,var(--bg) 0%, var(--bg2) 100%);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1140px; margin:0 auto; padding:24px}

    /* Header / Breadcrumbs */
    .head{padding:110px 0 16px}
    .crumbs{color:var(--muted); display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .crumbs a{color:var(--muted)}
    .title{margin:10px 0 0; font-size:26px; letter-spacing:-.01em}
    .subtitle{margin:6px 0 0; color:var(--muted)}

    /* Flash messages */
    .flash{display:grid; gap:8px; margin:14px 0}
    .flash__item{padding:10px 12px; border-radius:10px; border:var(--bd);
      background:linear-gradient(90deg, rgba(0,255,204,.05), rgba(108,92,231,.04))}
    .flash__item--error{border-color:rgba(255,107,107,.35);
      background:linear-gradient(90deg, rgba(255,107,107,.08), rgba(255,255,255,.02))}

    /* Layout */
    .lesson-wrap{display:grid; grid-template-columns: 1fr 320px; gap:22px; padding-bottom:64px}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.015), rgba(255,255,255,.006));
      border:var(--bd); border-radius:12px; box-shadow:var(--shadow); overflow:hidden;
    }
    .panel__head{padding:14px 16px; border-bottom:var(--bd); display:flex; align-items:center; justify-content:space-between; gap:10px}
    .panel__title{margin:0; font-size:16px}
    .panel__body{padding:16px}

    /* Video */
    .video-frame{position:relative; width:100%; aspect-ratio:16/9; border-radius:12px; overflow:hidden; border:var(--bd); background:#000}
    .video-frame iframe{position:absolute; inset:0; width:100%; height:100%; border:0}

    /* Content */
    .content{display:grid; gap:16px}
    .content .html{line-height:1.65; color:var(--text)}
    .content .html h2, .content .html h3{margin:14px 0 8px}
    .content .html p{margin:0 0 10px}
    .content .html code{font-family:"Fira Code",monospace; background:rgba(255,255,255,.06); padding:2px 6px; border-radius:6px}

    /* Terminal (feedback / lab actions) */
    .terminal{
      border:var(--bd); border-radius:12px; overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    }
    .terminal__head{display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:var(--bd)}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot--r{background:#ff6b6b}.dot--y{background:#ffd76b}.dot--g{background:#7ef0b0}
    .terminal__title{margin-left:auto; color:var(--muted); font-size:12px}
    .terminal__body{
      font-family:"Fira Code",monospace; font-size:13px; color:var(--accent);
      min-height:140px; padding:12px 10px; white-space:pre-wrap; line-height:1.35;
    }
    .terminal__footer{display:flex; justify-content:space-between; align-items:center; padding:8px 10px; border-top:var(--bd); color:var(--muted); font-size:13px}

    /* Buttons / inputs */
    .btn{
      display:inline-flex; gap:8px; align-items:center; padding:10px 14px; border-radius:12px; cursor:pointer;
      border:1px solid rgba(0,255,204,.18); color:var(--accent);
      background:linear-gradient(90deg, rgba(0,255,204,.08), rgba(108,92,231,.06));
      font-weight:800; text-decoration:none; transition:transform .12s, box-shadow .2s;
    }
    .btn:hover{box-shadow:0 6px 22px rgba(0,255,204,.08)}
    .btn--ghost{border:1px solid rgba(255,255,255,.12); background:transparent; color:var(--muted)}
    .btn--danger{border-color:rgba(255,107,107,.35); color:#ffd1d1; background:linear-gradient(90deg, rgba(255,107,107,.08), rgba(255,255,255,.02))}
    .btn--block{display:flex; justify-content:center; width:100%}
    .btn--small{padding:8px 10px; border-radius:10px; font-size:13px}

    .input, .select, .textarea{
      width:100%; font-size:14px; color:var(--text);
      background:rgba(255,255,255,.03); border:var(--bd); border-radius:10px; padding:10px 12px;
    }
    .input:focus, .select:focus, .textarea:focus{outline:none; border-color:rgba(0,255,204,.28); box-shadow:0 0 0 4px rgba(0,255,204,.08)}

    /* Test form */
    .q{border:var(--bd); border-radius:12px; padding:12px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); margin-bottom:12px}
    .q h3{margin:0 0 8px; font-size:16px}
    .opts{display:grid; gap:8px}
    .opt{
      display:flex; gap:10px; align-items:flex-start; padding:10px; border-radius:10px; border:1px solid transparent;
      background:linear-gradient(180deg, rgba(255,255,255,.012), rgba(255,255,255,.008));
      cursor:pointer
    }
    .opt:hover{border-color:rgba(0,255,204,.18)}
    .opt input{margin-top:2px}

    /* Sidebar (lesson meta / actions) */
    .side{position:sticky; top:18px; display:grid; gap:14px; height:fit-content}
    .info-row{display:flex; gap:10px; align-items:center; color:var(--muted); font-size:14px}
    .pill{display:inline-block; padding:6px 10px; border-radius:999px; border:var(--bd); color:#fff;
      background:rgba(0,0,0,.22)}
    .pill--lecture{color:#9fe2ff; border-color:rgba(159,226,255,.35)}
    .pill--test{color:#ffd76b; border-color:rgba(255,215,107,.35)}
    .pill--lab{color:#7ef0b0; border-color:rgba(126,240,176,.35)}

    /* Responsive */
    @media (max-width: 980px){ .lesson-wrap{grid-template-columns:1fr} .side{position:static} }
  </style>
</head>
<body>

  <section class="head">
    <div class="container">
      <div class="crumbs">
        <a href="{{ url_for('course.course_detail', course_id=course.id) }}"><i class="fa-solid fa-arrow-left"></i> Назад к курсу</a>
        <span>•</span>
        <span>{{ course.name }}</span>
      </div>
      <h1 class="title">{{ lesson.title }}</h1>
      <p class="subtitle">
        {% if lesson.lesson_type == 'lecture' %}Лекция{% elif lesson.lesson_type == 'test' %}Тест{% else %}Лабораторная{% endif %}
      </p>

      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash">
          {% for category, message in messages %}
            <div class="flash__item {% if category in ['error','danger'] %}flash__item--error{% endif %}">
              <strong style="text-transform:capitalize">{{ category }}</strong>: {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
      {% endwith %}
    </div>
  </section>

  <section>
    <div class="container lesson-wrap">

      <!-- MAIN -->
      <div class="panel">
        <div class="panel__head">
          <h3 class="panel__title"><i class="fa-regular fa-file-lines"></i> Содержимое урока</h3>
        </div>
        <div class="panel__body content">

          {% if lesson.lesson_type == 'lecture' %}
            {% if lesson.video_url %}
              <div class="video-frame">
                <iframe src="{{ lesson.video_url }}" allowfullscreen></iframe>
              </div>
            {% endif %}
            <div class="html">
              {{ lesson.html_content|safe }}
            </div>

            {% if current_user.status == 'student' %}
              <div class="lesson-progress" style="margin-top:18px; display:flex; gap:10px; align-items:center">
                <button id="mark-complete"
                        type="button"
                        class="btn btn--small">
                  <i class="fa-regular fa-circle-check"></i> Отметить как просмотренную
                </button>
                <span id="mark-complete-msg" class="lesson__meta" style="font-size:13px; color:#9fb3c8"></span>
              </div>
              {% endif %}

          {% elif lesson.lesson_type == 'test' and lesson.test %}
            <form method="post" action="{{ url_for('course.submit_test', course_id=course.id, lesson_id=lesson.id) }}">
              {% for q in lesson.test.questions %}
              <div class="q">
                <h3>{{ loop.index }}. {{ q.question }}</h3>
                <div class="opts">
                  {% for opt in q.options %}
                  <label class="opt">
                    <input type="radio" name="q_{{ q.id }}" value="{{ opt.id }}" required>
                    <span>{{ opt.option_text }}</span>
                  </label>
                  {% endfor %}
                </div>
              </div>
              {% endfor %}
              <button type="submit" class="btn"><i class="fa-solid fa-paper-plane"></i> Отправить тест</button>
            </form>

          {% elif lesson.lesson_type == 'lab' %}
            <div class="html">
              <p>Лабораторная работа выполняется в изолированной песочнице. Запустите окружение, выполните задание и отправьте флаг.</p>
            </div>

            {% if lesson.sandbox_slug %}
              <div class="terminal" id="lab-terminal">
                <div class="terminal__head">
                  <span class="dot dot--r"></span><span class="dot dot--y"></span><span class="dot dot--g"></span>
                  <div class="terminal__title">sandbox@skillup: ~</div>
                </div>
                <pre class="terminal__body" id="term-body">Готово к запуску. Нажмите «Запустить песочницу»…</pre>
                <div class="terminal__footer">
                  <span><i class="fa-solid fa-shield-halved"></i> изолированная среда</span>
                  <div style="display:flex; gap:8px; align-items:center">
                    <!-- форма запуска — НЕ МЕНЯЮ ИМЕНА/МЕТОД -->
                    <form id="start-lab" method="post" action="{{ url_for('course.start_lab', course_id=course.id, lesson_id=lesson.id) }}" target="_blank" style="display:inline">
                      <button class="btn btn--small" type="submit"><i class="fa-solid fa-play"></i> Запустить</button>
                    </form>
                    <!-- форма флага — НЕ МЕНЯЮ ИМЕНА/МЕТОД -->
                    <form id="flag-form" method="post" action="{{ url_for('course.submit_flag', course_id=course.id, lesson_id=lesson.id) }}" style="display:flex; gap:8px; align-items:center">
                      <input class="input" style="width:220px" type="text" name="flag" placeholder="FLAG{...}" required>
                      <button class="btn btn--small" type="submit"><i class="fa-solid fa-paper-plane"></i> Отправить</button>
                    </form>
                  </div>
                </div>
              </div>
            {% else %}
              <div class="q"><strong style="color:#ffb3b3">Sandbox slug не задан.</strong></div>
            {% endif %}
          {% endif %}

        </div>
      </div>

      <!-- SIDEBAR -->
      <aside class="side">
        <div class="panel">
          <div class="panel__head">
            <h3 class="panel__title"><i class="fa-regular fa-circle-question"></i> О уроке</h3>
          </div>
          <div class="panel__body">
            <div class="info-row">
              <span class="pill
                {% if lesson.lesson_type == 'lecture' %}pill--lecture
                {% elif lesson.lesson_type == 'test' %}pill--test
                {% else %}pill--lab{% endif %}">
                {% if lesson.lesson_type == 'lecture' %}Лекция{% elif lesson.lesson_type == 'test' %}Тест{% else %}Лаба{% endif %}
              </span>
            </div>
            <div class="info-row"><i class="fa-regular fa-folder-open"></i> <span>{{ course.name }}</span></div>
            {% if lesson.lesson_type == 'lecture' and lesson.video_url %}
            <div class="info-row"><i class="fa-regular fa-circle-play"></i> <span>Есть видео</span></div>
            {% endif %}
            <div class="info-row"><i class="fa-regular fa-clock"></i> <span>Самостоятельный темп</span></div>
          </div>
        </div>

        <a class="btn btn--ghost btn--block" href="{{ url_for('course.course_detail', course_id=course.id) }}">
          <i class="fa-solid fa-arrow-left"></i> Назад к курсу
        </a>
      </aside>

    </div>
  </section>

  <script>
    // Небольшие улучшения UX для лабы: печатаем в «терминал» при действиях
    (function(){

      const btnComplete = document.getElementById('mark-complete');
      const msg = document.getElementById('mark-complete-msg');
      if (btnComplete) {
        btnComplete.addEventListener('click', function (e) {
          e.preventDefault();
          btnComplete.disabled = true;
          if (msg) msg.textContent = 'Отправка...';

          fetch("{{ url_for('course.mark_lesson_completed', lesson_id=lesson.id) }}", {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(r => r.json())
          .then(data => {
            if (data.success) {
              if (msg) msg.textContent = data.message || 'Лекция отмечена.';
            } else {
              if (msg) msg.textContent = data.error || 'Ошибка при сохранении прогресса';
              btnComplete.disabled = false;
            }
          })
          .catch(() => {
            if (msg) msg.textContent = 'Сетевая ошибка';
            btnComplete.disabled = false;
          });
        });
      }
      const term = document.getElementById('term-body');
      const formStart = document.getElementById('start-lab');
      const formFlag = document.getElementById('flag-form');
      if(!term) return;

      function log(line){ term.textContent += (term.textContent ? "\\n" : "") + line; term.scrollTop = term.scrollHeight; }

      if(formStart){
        formStart.addEventListener('submit', () => {
          log("[*] Provisioning sandbox...");
          setTimeout(()=>log("[+] Песочница открыта в новой вкладке."), 300);
        });
      }

      if(formFlag){
        formFlag.addEventListener('submit', () => {
          const flag = formFlag.querySelector('input[name="flag"]').value || "FLAG{...}";
          log("[*] Отправка флага: " + flag);
          setTimeout(()=>log("[i] Проверка выполняется на сервере..."), 150);
          // фактический результат вернётся флешем после редиректа рендера страницы
        });
      }
    })();
  </script>
</body>
</html>
